name: Database Migration

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - development
          - staging
          - production
      action:
        description: "Migration action"
        required: true
        type: choice
        options:
          - migrate
          - rollback
          - status
          - seed
      steps:
        description: "Number of migrations to rollback (only for rollback action)"
        required: false
        type: number
        default: 1

env:
  NODE_VERSION: "20"

jobs:
  # ========================================
  # Pre-migration Checks
  # ========================================
  pre-migration-check:
    name: Pre-migration Validation
    runs-on: ubuntu-latest
    outputs:
      can_proceed: ${{ steps.check.outputs.can_proceed }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Validate migration files
        id: check
        working-directory: ./server
        run: |
          echo "ðŸ” Validating migration files..."

          # Check for pending migrations
          if [ -d "src/migrations" ]; then
            MIGRATION_COUNT=$(ls -1 src/migrations/*.ts 2>/dev/null | wc -l)
            echo "Found $MIGRATION_COUNT migration files"
            
            if [ $MIGRATION_COUNT -gt 0 ]; then
              echo "can_proceed=true" >> $GITHUB_OUTPUT
            else
              echo "âš ï¸ No migration files found"
              echo "can_proceed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "âŒ Migration directory not found"
            echo "can_proceed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Create backup recommendation
        run: |
          echo "## âš ï¸ Pre-migration Checklist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Before proceeding:" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Database backup completed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Application in maintenance mode (if required)" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Migration files reviewed" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Rollback plan prepared" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Development Migration
  # ========================================
  migrate-development:
    name: Development Migration
    runs-on: ubuntu-latest
    needs: pre-migration-check
    if: inputs.environment == 'development'

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: ai_chatbot_dev
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: "npm"
          cache-dependency-path: server/package-lock.json

      - name: Install dependencies
        working-directory: ./server
        run: npm ci

      - name: Run migration action
        working-directory: ./server
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/ai_chatbot_dev
          NODE_ENV: development
        run: |
          if [ "${{ inputs.action }}" == "migrate" ]; then
            echo "ðŸš€ Running migrations..."
            npm run migrate
          elif [ "${{ inputs.action }}" == "rollback" ]; then
            echo "ðŸ”„ Rolling back migrations..."
            for i in $(seq 1 ${{ inputs.steps }}); do
              npm run migrate:undo
            done
          elif [ "${{ inputs.action }}" == "status" ]; then
            echo "ðŸ“Š Checking migration status..."
            npm run migrate:status
          elif [ "${{ inputs.action }}" == "seed" ]; then
            echo "ðŸŒ± Running seeders..."
            npx sequelize-cli db:seed:all || echo "No seeders configured"
          fi

      - name: Create report
        run: |
          echo "## âœ… Development Migration Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Success" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Staging Migration
  # ========================================
  migrate-staging:
    name: Staging Migration
    runs-on: ubuntu-latest
    needs: pre-migration-check
    if: inputs.environment == 'staging' && needs.pre-migration-check.outputs.can_proceed == 'true'
    environment:
      name: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.STAGING_HOST }} >> ~/.ssh/known_hosts

      - name: Create database backup
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'ENDSSH'
            BACKUP_FILE="/backups/staging-db-$(date +%Y%m%d_%H%M%S).sql"
            docker exec ai-chatbot-postgres pg_dump -U postgres ai_chatbot > $BACKUP_FILE
            echo "âœ… Backup created: $BACKUP_FILE"
          ENDSSH

      - name: Run migration
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'ENDSSH'
            set -e
            cd ${{ secrets.STAGING_DEPLOY_PATH }}
            
            if [ "${{ inputs.action }}" == "migrate" ]; then
              echo "ðŸš€ Running migrations on staging..."
              docker exec ai-chatbot-server npm run migrate
            elif [ "${{ inputs.action }}" == "rollback" ]; then
              echo "ðŸ”„ Rolling back migrations on staging..."
              for i in $(seq 1 ${{ inputs.steps }}); do
                docker exec ai-chatbot-server npm run migrate:undo
              done
            elif [ "${{ inputs.action }}" == "status" ]; then
              echo "ðŸ“Š Checking migration status on staging..."
              docker exec ai-chatbot-server npm run migrate:status
            fi
            
            echo "âœ… Migration action completed"
          ENDSSH

      - name: Verify database
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.STAGING_USER }}@${{ secrets.STAGING_HOST }} << 'ENDSSH'
            # Test database connectivity
            docker exec ai-chatbot-postgres psql -U postgres -d ai_chatbot -c "SELECT version();"
            echo "âœ… Database verification passed"
          ENDSSH

      - name: Test application
        run: |
          echo "Testing application after migration..."
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.STAGING_URL }}/api/health || echo "000")
          if [ "$response" != "200" ]; then
            echo "âŒ Application health check failed"
            exit 1
          fi
          echo "âœ… Application is healthy"

      - name: Create report
        run: |
          echo "## âœ… Staging Migration Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Staging" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "**Backup:** Created" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Production Migration
  # ========================================
  migrate-production:
    name: Production Migration
    runs-on: ubuntu-latest
    needs: pre-migration-check
    if: inputs.environment == 'production' && needs.pre-migration-check.outputs.can_proceed == 'true'
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.PRODUCTION_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.PRODUCTION_HOST }} >> ~/.ssh/known_hosts

      - name: Create comprehensive backup
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            set -e
            BACKUP_DIR="/backups/production-$(date +%Y%m%d_%H%M%S)"
            mkdir -p $BACKUP_DIR
            
            echo "ðŸ“¦ Creating comprehensive backup..."
            
            # Database backup with compression
            docker exec ai-chatbot-postgres pg_dump -U postgres ai_chatbot | gzip > $BACKUP_DIR/database.sql.gz
            
            # Schema only backup
            docker exec ai-chatbot-postgres pg_dump -U postgres --schema-only ai_chatbot > $BACKUP_DIR/schema.sql
            
            # Data only backup
            docker exec ai-chatbot-postgres pg_dump -U postgres --data-only ai_chatbot > $BACKUP_DIR/data.sql
            
            # Get current migration status
            docker exec ai-chatbot-server npm run migrate:status > $BACKUP_DIR/migration-status.txt
            
            echo "âœ… Comprehensive backup completed: $BACKUP_DIR"
            echo "BACKUP_DIR=$BACKUP_DIR" >> $GITHUB_ENV
          ENDSSH

      - name: Enable maintenance mode
        if: inputs.action == 'migrate' || inputs.action == 'rollback'
        run: |
          echo "ðŸš§ Enabling maintenance mode..."
          # Add logic to enable maintenance mode
          # This could be a feature flag, nginx config, or application setting

      - name: Run production migration
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            set -e
            cd ${{ secrets.PRODUCTION_DEPLOY_PATH }}
            
            echo "ðŸš€ Starting production database migration..."
            
            if [ "${{ inputs.action }}" == "migrate" ]; then
              echo "Running forward migrations..."
              docker exec ai-chatbot-server npm run migrate
              
            elif [ "${{ inputs.action }}" == "rollback" ]; then
              echo "âš ï¸ Rolling back ${{ inputs.steps }} migration(s)..."
              for i in $(seq 1 ${{ inputs.steps }}); do
                docker exec ai-chatbot-server npm run migrate:undo
              done
              
            elif [ "${{ inputs.action }}" == "status" ]; then
              echo "Checking migration status..."
              docker exec ai-chatbot-server npm run migrate:status
            fi
            
            echo "âœ… Production migration completed"
          ENDSSH

      - name: Verify production database
        run: |
          ssh -i ~/.ssh/deploy_key ${{ secrets.PRODUCTION_USER }}@${{ secrets.PRODUCTION_HOST }} << 'ENDSSH'
            echo "ðŸ” Verifying database integrity..."
            
            # Check database connectivity
            docker exec ai-chatbot-postgres psql -U postgres -d ai_chatbot -c "SELECT version();"
            
            # Check table counts
            docker exec ai-chatbot-postgres psql -U postgres -d ai_chatbot -c "SELECT schemaname, tablename FROM pg_tables WHERE schemaname = 'public';"
            
            # Verify migrations table
            docker exec ai-chatbot-postgres psql -U postgres -d ai_chatbot -c "SELECT * FROM \"SequelizeMeta\" ORDER BY name;"
            
            echo "âœ… Database verification passed"
          ENDSSH

      - name: Test production application
        run: |
          echo "Testing production application..."

          # Health check
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/api/health || echo "000")
          if [ "$response" != "200" ]; then
            echo "âŒ Health check failed"
            exit 1
          fi

          # Test database connectivity through API
          response=$(curl -s -o /dev/null -w "%{http_code}" ${{ secrets.PRODUCTION_URL }}/api/auth/login -X POST || echo "000")
          if [ "$response" != "400" ] && [ "$response" != "401" ]; then
            echo "âŒ API check failed"
            exit 1
          fi

          echo "âœ… Application tests passed"

      - name: Disable maintenance mode
        if: always()
        run: |
          echo "âœ… Disabling maintenance mode..."
          # Add logic to disable maintenance mode

      - name: Create production report
        run: |
          echo "## âœ… Production Migration Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** Production" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Success" >> $GITHUB_STEP_SUMMARY
          echo "**Backup:** Created and verified" >> $GITHUB_STEP_SUMMARY
          echo "**Verification:** All checks passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Post-migration Tasks" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Database backup created" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Migration executed" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Database verified" >> $GITHUB_STEP_SUMMARY
          echo "- [x] Application tested" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Monitor application logs" >> $GITHUB_STEP_SUMMARY
          echo "- [ ] Update documentation" >> $GITHUB_STEP_SUMMARY

  # ========================================
  # Post-migration Monitoring
  # ========================================
  post-migration-check:
    name: Post-migration Monitoring
    runs-on: ubuntu-latest
    needs: [migrate-development, migrate-staging, migrate-production]
    if: always() && (needs.migrate-development.result == 'success' || needs.migrate-staging.result == 'success' || needs.migrate-production.result == 'success')

    steps:
      - name: Monitor application
        run: |
          echo "ðŸ“Š Setting up post-migration monitoring..."

          # Wait 2 minutes and check again
          sleep 120

          if [ "${{ inputs.environment }}" == "staging" ]; then
            URL="${{ secrets.STAGING_URL }}"
          elif [ "${{ inputs.environment }}" == "production" ]; then
            URL="${{ secrets.PRODUCTION_URL }}"
          else
            echo "Skipping monitoring for development"
            exit 0
          fi

          response=$(curl -s -o /dev/null -w "%{http_code}" $URL/api/health || echo "000")
          if [ "$response" != "200" ]; then
            echo "âš ï¸ Application health degraded after migration"
          else
            echo "âœ… Application stable after 2 minutes"
          fi

      - name: Create final summary
        run: |
          echo "## ðŸŽ‰ Migration Workflow Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Action:** ${{ inputs.action }}" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor error logs for anomalies" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify data integrity" >> $GITHUB_STEP_SUMMARY
          echo "3. Update team documentation" >> $GITHUB_STEP_SUMMARY
          echo "4. Close related tickets" >> $GITHUB_STEP_SUMMARY
